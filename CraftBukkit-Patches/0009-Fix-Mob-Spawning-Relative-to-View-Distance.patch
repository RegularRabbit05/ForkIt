From 029d86f41a5d2bbe2424ba9e1efa3e0962e1747f Mon Sep 17 00:00:00 2001
From: md_5 <git@md-5.net>
Date: Fri, 21 Jun 2013 17:29:54 +1000
Subject: [PATCH] Fix Mob Spawning Relative to View Distance

Changes the mob spawning algorithm to properly account for view distance and the range around players.

Needs better documentation.

diff --git a/src/main/java/net/minecraft/server/level/ChunkMap.java b/src/main/java/net/minecraft/server/level/ChunkMap.java
index 0b0c39855c..dbdca5928c 100644
--- a/src/main/java/net/minecraft/server/level/ChunkMap.java
+++ b/src/main/java/net/minecraft/server/level/ChunkMap.java
@@ -1065,9 +1065,15 @@ public class ChunkMap extends SimpleRegionStorage implements ChunkHolder.PlayerP
     }
 
     boolean anyPlayerCloseEnoughForSpawning(ChunkPos chunkpos) {
+        // Spigot start
+        return anyPlayerCloseEnoughForSpawning(chunkpos, false);
+    }
+
+    boolean anyPlayerCloseEnoughForSpawning(ChunkPos chunkpos, boolean reducedRange) {
+        // Spigot end
         TriState tristate = this.distanceManager.hasPlayersNearby(chunkpos.toLong());
 
-        return tristate == TriState.DEFAULT ? this.anyPlayerCloseEnoughForSpawningInternal(chunkpos) : tristate.toBoolean(true);
+        return tristate == TriState.DEFAULT ? this.anyPlayerCloseEnoughForSpawningInternal(chunkpos, reducedRange) : tristate.toBoolean(true); // Spigot
     }
 
     boolean anyPlayerCloseEnoughTo(BlockPos blockpos, int i) {
@@ -1083,8 +1089,19 @@ public class ChunkMap extends SimpleRegionStorage implements ChunkHolder.PlayerP
     }
 
     private boolean anyPlayerCloseEnoughForSpawningInternal(ChunkPos chunkpos) {
+        // Spigot start
+        return anyPlayerCloseEnoughForSpawningInternal(chunkpos, false);
+    }
+
+    private boolean anyPlayerCloseEnoughForSpawningInternal(ChunkPos chunkpos, boolean reducedRange) {
+        int chunkRange = level.spigotConfig.mobSpawnRange;
+        chunkRange = (chunkRange > level.spigotConfig.viewDistance) ? (byte) level.spigotConfig.viewDistance : chunkRange;
+        chunkRange = (chunkRange > 8) ? 8 : chunkRange;
+
+        double blockRange = (reducedRange) ? Math.pow(chunkRange << 4, 2) : 16384.0D;
+        // Spigot end
         for (ServerPlayer serverplayer : this.playerMap.getAllPlayers()) {
-            if (this.playerIsCloseEnoughForSpawning(serverplayer, chunkpos)) {
+            if (this.playerIsCloseEnoughForSpawning(serverplayer, chunkpos, blockRange)) { // Spigot
                 return true;
             }
         }
@@ -1101,7 +1118,7 @@ public class ChunkMap extends SimpleRegionStorage implements ChunkHolder.PlayerP
             ImmutableList.Builder<ServerPlayer> immutablelist_builder = ImmutableList.builder();
 
             for (ServerPlayer serverplayer : this.playerMap.getAllPlayers()) {
-                if (this.playerIsCloseEnoughForSpawning(serverplayer, chunkpos)) {
+                if (this.playerIsCloseEnoughForSpawning(serverplayer, chunkpos, 16384.0D)) { // Spigot
                     immutablelist_builder.add(serverplayer);
                 }
             }
@@ -1110,13 +1127,13 @@ public class ChunkMap extends SimpleRegionStorage implements ChunkHolder.PlayerP
         }
     }
 
-    private boolean playerIsCloseEnoughForSpawning(ServerPlayer serverplayer, ChunkPos chunkpos) {
+    private boolean playerIsCloseEnoughForSpawning(ServerPlayer serverplayer, ChunkPos chunkpos, double range) { // Spigot
         if (serverplayer.isSpectator()) {
             return false;
         } else {
             double d0 = euclideanDistanceSquared(chunkpos, serverplayer.position());
 
-            return d0 < 16384.0D;
+            return d0 < range; // Spigot
         }
     }
 
diff --git a/src/main/java/net/minecraft/server/level/ServerChunkCache.java b/src/main/java/net/minecraft/server/level/ServerChunkCache.java
index a6d528e683..3aff16c92d 100644
--- a/src/main/java/net/minecraft/server/level/ServerChunkCache.java
+++ b/src/main/java/net/minecraft/server/level/ServerChunkCache.java
@@ -471,7 +471,7 @@ public class ServerChunkCache extends ChunkSource {
         }
 
         if (!list.isEmpty()) {
-            if (this.level.canSpawnEntitiesInChunk(chunkpos)) {
+            if (this.level.canSpawnEntitiesInChunk(chunkpos) && this.chunkMap.anyPlayerCloseEnoughForSpawning(chunkpos, true)) { // Spigot
                 NaturalSpawner.spawnForChunk(this.level, levelchunk, naturalspawner_spawnstate, list);
             }
 
diff --git a/src/main/java/org/spigotmc/SpigotWorldConfig.java b/src/main/java/org/spigotmc/SpigotWorldConfig.java
index acaf903011..0c0c29efe5 100644
--- a/src/main/java/org/spigotmc/SpigotWorldConfig.java
+++ b/src/main/java/org/spigotmc/SpigotWorldConfig.java
@@ -180,4 +180,11 @@ public class SpigotWorldConfig
 
         log( "Simulation Distance: " + simulationDistance );
     }
+
+    public byte mobSpawnRange;
+    private void mobSpawnRange()
+    {
+        mobSpawnRange = (byte) getInt( "mob-spawn-range", 6 );
+        log( "Mob Spawn Range: " + mobSpawnRange );
+    }
 }
-- 
2.52.0

