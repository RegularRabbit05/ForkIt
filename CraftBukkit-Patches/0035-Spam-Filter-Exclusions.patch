From d7ac42578415c225621a3c3e3d058ca7f2f17e24 Mon Sep 17 00:00:00 2001
From: md_5 <git@md-5.net>
Date: Sat, 8 Feb 2014 08:13:40 +0000
Subject: [PATCH] Spam Filter Exclusions


diff --git a/src/main/java/net/minecraft/server/network/ServerGamePacketListenerImpl.java b/src/main/java/net/minecraft/server/network/ServerGamePacketListenerImpl.java
index ce0a83628..e7a85f8de 100644
--- a/src/main/java/net/minecraft/server/network/ServerGamePacketListenerImpl.java
+++ b/src/main/java/net/minecraft/server/network/ServerGamePacketListenerImpl.java
@@ -2073,7 +2073,7 @@ public class ServerGamePacketListenerImpl extends ServerCommonPacketListenerImpl
             }
             // CraftBukkit end
             this.performUnsignedChatCommand(packet.command());
-            this.detectRateSpam();
+            this.detectRateSpam("/" + packet.command()); // Spigot
         }, true); // CraftBukkit - sync commands
     }
 
@@ -2112,7 +2112,7 @@ public class ServerGamePacketListenerImpl extends ServerCommonPacketListenerImpl
                 }
                 // CraftBukkit end
                 this.performSignedChatCommand(packet, (LastSeenMessages) optional.get());
-                this.detectRateSpam();
+                this.detectRateSpam("/" + packet.command()); // Spigot
             }, true); // CraftBukkit - sync commands
         }
     }
@@ -2399,11 +2399,20 @@ public class ServerGamePacketListenerImpl extends ServerCommonPacketListenerImpl
         }
         // this.server.getPlayerList().broadcastChatMessage(playerchatmessage, this.player, ChatType.bind(ChatType.CHAT, (Entity) this.player));
         // CraftBukkit end
-        this.detectRateSpam();
+        this.detectRateSpam(s); // Spigot
     }
 
-    private void detectRateSpam() {
+    // Spigot start - spam exclusions
+    private void detectRateSpam(String s) {
         // CraftBukkit start - replaced with thread safe throttle
+        for ( String exclude : org.spigotmc.SpigotConfig.spamExclusions )
+        {
+            if ( exclude != null && s.startsWith( exclude ) )
+            {
+                return;
+            }
+        }
+        // Spigot end
         // this.chatSpamThrottler.increment();
         if (!this.chatSpamThrottler.isIncrementAndUnderThreshold() && !this.server.getPlayerList().isOp(this.player.nameAndId()) && !this.server.isSingleplayerOwner(this.player.nameAndId())) {
             // CraftBukkit end
diff --git a/src/main/java/org/spigotmc/SpigotConfig.java b/src/main/java/org/spigotmc/SpigotConfig.java
index 9744e9456..d53c089eb 100644
--- a/src/main/java/org/spigotmc/SpigotConfig.java
+++ b/src/main/java/org/spigotmc/SpigotConfig.java
@@ -6,6 +6,7 @@ import java.io.IOException;
 import java.lang.reflect.InvocationTargetException;
 import java.lang.reflect.Method;
 import java.lang.reflect.Modifier;
+import java.util.Arrays;
 import java.util.HashMap;
 import java.util.List;
 import java.util.Map;
@@ -284,4 +285,13 @@ public class SpigotConfig
     {
         playerShuffle = getInt( "settings.player-shuffle", 0 );
     }
+
+    public static List<String> spamExclusions;
+    private static void spamExclusions()
+    {
+        spamExclusions = getList( "commands.spam-exclusions", Arrays.asList( new String[]
+        {
+                "/skill"
+        } ) );
+    }
 }
-- 
2.52.0

