From d4118893c7d204265f772c622c01c670b35a53a5 Mon Sep 17 00:00:00 2001
From: Thinkofdeath <thinkofdeath@spigotmc.org>
Date: Sun, 29 Jun 2014 21:10:34 +0100
Subject: [PATCH] Limit block placement/interaction packets


diff --git a/src/main/java/net/minecraft/network/protocol/game/ServerboundUseItemOnPacket.java b/src/main/java/net/minecraft/network/protocol/game/ServerboundUseItemOnPacket.java
index 57af3fcdb3..dc053521a3 100644
--- a/src/main/java/net/minecraft/network/protocol/game/ServerboundUseItemOnPacket.java
+++ b/src/main/java/net/minecraft/network/protocol/game/ServerboundUseItemOnPacket.java
@@ -14,6 +14,7 @@ public class ServerboundUseItemOnPacket implements Packet<ServerGamePacketListen
     private final BlockHitResult blockHit;
     private final InteractionHand hand;
     private final int sequence;
+    public long timestamp; // Spigot
 
     public ServerboundUseItemOnPacket(InteractionHand interactionhand, BlockHitResult blockhitresult, int i) {
         this.hand = interactionhand;
@@ -22,6 +23,7 @@ public class ServerboundUseItemOnPacket implements Packet<ServerGamePacketListen
     }
 
     private ServerboundUseItemOnPacket(FriendlyByteBuf friendlybytebuf) {
+        this.timestamp = System.currentTimeMillis(); // Spigot
         this.hand = (InteractionHand) friendlybytebuf.readEnum(InteractionHand.class);
         this.blockHit = friendlybytebuf.readBlockHitResult();
         this.sequence = friendlybytebuf.readVarInt();
diff --git a/src/main/java/net/minecraft/network/protocol/game/ServerboundUseItemPacket.java b/src/main/java/net/minecraft/network/protocol/game/ServerboundUseItemPacket.java
index b174e9c966..1d8ec60f21 100644
--- a/src/main/java/net/minecraft/network/protocol/game/ServerboundUseItemPacket.java
+++ b/src/main/java/net/minecraft/network/protocol/game/ServerboundUseItemPacket.java
@@ -14,6 +14,7 @@ public class ServerboundUseItemPacket implements Packet<ServerGamePacketListener
     private final int sequence;
     private final float yRot;
     private final float xRot;
+    public long timestamp; // Spigot
 
     public ServerboundUseItemPacket(InteractionHand interactionhand, int i, float f, float f1) {
         this.hand = interactionhand;
@@ -23,6 +24,7 @@ public class ServerboundUseItemPacket implements Packet<ServerGamePacketListener
     }
 
     private ServerboundUseItemPacket(FriendlyByteBuf friendlybytebuf) {
+        this.timestamp = System.currentTimeMillis(); // Spigot
         this.hand = (InteractionHand) friendlybytebuf.readEnum(InteractionHand.class);
         this.sequence = friendlybytebuf.readVarInt();
         this.yRot = friendlybytebuf.readFloat();
diff --git a/src/main/java/net/minecraft/server/network/ServerGamePacketListenerImpl.java b/src/main/java/net/minecraft/server/network/ServerGamePacketListenerImpl.java
index 6cbc089c6d..fd2f2da9bd 100644
--- a/src/main/java/net/minecraft/server/network/ServerGamePacketListenerImpl.java
+++ b/src/main/java/net/minecraft/server/network/ServerGamePacketListenerImpl.java
@@ -1804,10 +1804,30 @@ public class ServerGamePacketListenerImpl extends ServerCommonPacketListenerImpl
         }
     }
 
+    // Spigot start - limit place/interactions
+    private int limitedPackets;
+    private long lastLimitedPacket = -1;
+
+    private boolean checkLimit(long timestamp) {
+        if (lastLimitedPacket != -1 && timestamp - lastLimitedPacket < 30 && limitedPackets++ >= 4) {
+            return false;
+        }
+
+        if (lastLimitedPacket == -1 || timestamp - lastLimitedPacket >= 30) {
+            lastLimitedPacket = timestamp;
+            limitedPackets = 0;
+            return true;
+        }
+
+        return true;
+    }
+    // Spigot end
+
     @Override
     public void handleUseItemOn(ServerboundUseItemOnPacket serverbounduseitemonpacket) {
         PacketUtils.ensureRunningOnSameThread(serverbounduseitemonpacket, this, this.player.level());
         if (this.player.isImmobile()) return; // CraftBukkit
+        if (!checkLimit(serverbounduseitemonpacket.timestamp)) return; // Spigot - check limit
         if (this.hasClientLoaded()) {
             this.ackBlockChangesUpTo(serverbounduseitemonpacket.getSequence());
             ServerLevel serverlevel = this.player.level();
@@ -1870,6 +1890,7 @@ public class ServerGamePacketListenerImpl extends ServerCommonPacketListenerImpl
     public void handleUseItem(ServerboundUseItemPacket serverbounduseitempacket) {
         PacketUtils.ensureRunningOnSameThread(serverbounduseitempacket, this, this.player.level());
         if (this.player.isImmobile()) return; // CraftBukkit
+        if (!checkLimit(serverbounduseitempacket.timestamp)) return; // Spigot - check limit
         if (this.hasClientLoaded()) {
             this.ackBlockChangesUpTo(serverbounduseitempacket.getSequence());
             ServerLevel serverlevel = this.player.level();
-- 
2.52.0

