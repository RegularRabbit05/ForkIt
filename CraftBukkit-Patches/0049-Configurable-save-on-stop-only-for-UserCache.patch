From d8a70b08b91f3ba48ca1d02014c88f0d105b697b Mon Sep 17 00:00:00 2001
From: drXor <mcyoungsota@gmail.com>
Date: Fri, 23 May 2014 18:05:10 -0400
Subject: [PATCH] Configurable save-on-stop-only for UserCache


diff --git a/src/main/java/net/minecraft/server/MinecraftServer.java b/src/main/java/net/minecraft/server/MinecraftServer.java
index 373bb2eaa2..827dc0ac8d 100644
--- a/src/main/java/net/minecraft/server/MinecraftServer.java
+++ b/src/main/java/net/minecraft/server/MinecraftServer.java
@@ -1019,6 +1019,12 @@ public abstract class MinecraftServer extends ReentrantBlockableEventLoop<TickTa
         } catch (IOException ioexception1) {
             MinecraftServer.LOGGER.error("Failed to unlock level {}", this.storageSource.getLevelId(), ioexception1);
         }
+        // Spigot start
+        if (org.spigotmc.SpigotConfig.saveUserCacheOnStopOnly) {
+            LOGGER.info("Saving usercache.json");
+            this.services().nameToIdCache().save();
+        }
+        // Spigot end
 
     }
 
diff --git a/src/main/java/net/minecraft/server/players/CachedUserNameToIdResolver.java b/src/main/java/net/minecraft/server/players/CachedUserNameToIdResolver.java
index df72f195e6..b3cf5e271a 100644
--- a/src/main/java/net/minecraft/server/players/CachedUserNameToIdResolver.java
+++ b/src/main/java/net/minecraft/server/players/CachedUserNameToIdResolver.java
@@ -96,7 +96,7 @@ public class CachedUserNameToIdResolver implements UserNameToIdResolver {
         CachedUserNameToIdResolver.GameProfileInfo cachedusernametoidresolver_gameprofileinfo = new CachedUserNameToIdResolver.GameProfileInfo(nameandid, date);
 
         this.safeAdd(cachedusernametoidresolver_gameprofileinfo);
-        this.save();
+        if( !org.spigotmc.SpigotConfig.saveUserCacheOnStopOnly ) this.save(); // Spigot - skip saving if disabled
         return cachedusernametoidresolver_gameprofileinfo;
     }
 
@@ -133,7 +133,7 @@ public class CachedUserNameToIdResolver implements UserNameToIdResolver {
             }
         }
 
-        if (flag) {
+        if (flag && !org.spigotmc.SpigotConfig.saveUserCacheOnStopOnly) { // Spigot - skip saving if disabled
             this.save();
         }
 
diff --git a/src/main/java/org/spigotmc/SpigotConfig.java b/src/main/java/org/spigotmc/SpigotConfig.java
index c85de31677..d830925dbb 100644
--- a/src/main/java/org/spigotmc/SpigotConfig.java
+++ b/src/main/java/org/spigotmc/SpigotConfig.java
@@ -320,4 +320,10 @@ public class SpigotConfig
     {
         userCacheCap = getInt( "settings.user-cache-size", 1000 );
     }
+
+    public static boolean saveUserCacheOnStopOnly;
+    private static void saveUserCacheOnStopOnly()
+    {
+        saveUserCacheOnStopOnly = getBoolean( "settings.save-user-cache-on-stop-only", false );
+    }
 }
-- 
2.52.0

