From f0c139d45532edf11ef466e17e4a2c7c7fa76fb7 Mon Sep 17 00:00:00 2001
From: md_5 <git@md-5.net>
Date: Sat, 23 Mar 2013 09:46:33 +1100
Subject: [PATCH] Merge tweaks and configuration

This allows the merging of Experience orbs, as well as the configuration of the merge radius of items. Additionally it refactors the merge algorithm to be a better experience for players.

diff --git a/src/main/java/net/minecraft/world/entity/item/ItemEntity.java b/src/main/java/net/minecraft/world/entity/item/ItemEntity.java
index 54f137d495..dfc9de5422 100644
--- a/src/main/java/net/minecraft/world/entity/item/ItemEntity.java
+++ b/src/main/java/net/minecraft/world/entity/item/ItemEntity.java
@@ -226,7 +226,10 @@ public class ItemEntity extends Entity implements TraceableEntity {
 
     private void mergeWithNeighbours() {
         if (this.isMergable()) {
-            for (ItemEntity itementity : this.level().getEntitiesOfClass(ItemEntity.class, this.getBoundingBox().inflate(0.5D, 0.0D, 0.5D), (itementity1) -> {
+            // Spigot start
+            double radius = this.level().spigotConfig.itemMerge;
+            for (ItemEntity itementity : this.level().getEntitiesOfClass(ItemEntity.class, this.getBoundingBox().inflate(radius, radius - 0.5D, radius), (itementity1) -> {
+                // Spigot end
                 return itementity1 != this && itementity1.isMergable();
             })) {
                 if (itementity.isMergable()) {
@@ -251,7 +254,7 @@ public class ItemEntity extends Entity implements TraceableEntity {
         ItemStack itemstack1 = itementity.getItem();
 
         if (Objects.equals(this.target, itementity.target) && areMergable(itemstack, itemstack1)) {
-            if (itemstack1.getCount() < itemstack.getCount()) {
+            if (true || itemstack1.getCount() < itemstack.getCount()) { // Spigot
                 merge(this, itemstack, itementity, itemstack1);
             } else {
                 merge(itementity, itemstack1, this, itemstack);
diff --git a/src/main/java/org/bukkit/craftbukkit/event/CraftEventFactory.java b/src/main/java/org/bukkit/craftbukkit/event/CraftEventFactory.java
index 5795e1eb35..b5e2c1e6c8 100644
--- a/src/main/java/org/bukkit/craftbukkit/event/CraftEventFactory.java
+++ b/src/main/java/org/bukkit/craftbukkit/event/CraftEventFactory.java
@@ -692,6 +692,23 @@ public class CraftEventFactory {
             return false;
         }
 
+        // Spigot start - SPIGOT-7523: Merge after spawn event and only merge if the event was not cancelled (gets checked above)
+        if (entity instanceof ExperienceOrb xp) {
+            double radius = level.spigotConfig.expMerge;
+            if (radius > 0) {
+                List<Entity> entities = level.getEntities(entity, entity.getBoundingBox().inflate(radius, radius, radius));
+                for (Entity e : entities) {
+                    if (e instanceof ExperienceOrb loopItem) {
+                        if (!loopItem.isRemoved()) {
+                            xp.setValue(xp.getValue() + loopItem.getValue());
+                            loopItem.discard(null); // Add Bukkit remove cause
+                        }
+                    }
+                }
+            }
+        }
+        // Spigot end
+
         return true;
     }
 
diff --git a/src/main/java/org/spigotmc/SpigotWorldConfig.java b/src/main/java/org/spigotmc/SpigotWorldConfig.java
index f42972427b..5ff085b9e6 100644
--- a/src/main/java/org/spigotmc/SpigotWorldConfig.java
+++ b/src/main/java/org/spigotmc/SpigotWorldConfig.java
@@ -134,4 +134,18 @@ public class SpigotWorldConfig
         weepingVinesModifier = getAndValidateGrowth( "WeepingVines" );
         caveVinesModifier = getAndValidateGrowth( "CaveVines" );
     }
+
+    public double itemMerge;
+    private void itemMerge()
+    {
+        itemMerge = getDouble("merge-radius.item", 2.5 );
+        log( "Item Merge Radius: " + itemMerge );
+    }
+
+    public double expMerge;
+    private void expMerge()
+    {
+        expMerge = getDouble("merge-radius.exp", 3.0 );
+        log( "Experience Merge Radius: " + expMerge );
+    }
 }
-- 
2.52.0

