From cabb951b996a0d4a9f26427158144c2bdaba81fc Mon Sep 17 00:00:00 2001
From: erocs <github@erocs.org>
Date: Sun, 8 Sep 2013 12:06:15 -0700
Subject: [PATCH] Hopper Customisations

Allows editing hopper cooldowns and amount transferred per tick.

diff --git a/src/main/java/net/minecraft/world/level/block/entity/HopperBlockEntity.java b/src/main/java/net/minecraft/world/level/block/entity/HopperBlockEntity.java
index 6298aa549d..73cba31650 100644
--- a/src/main/java/net/minecraft/world/level/block/entity/HopperBlockEntity.java
+++ b/src/main/java/net/minecraft/world/level/block/entity/HopperBlockEntity.java
@@ -147,9 +147,14 @@ public class HopperBlockEntity extends RandomizableContainerBlockEntity implemen
         hopperblockentity.tickedGameTime = level.getGameTime();
         if (!hopperblockentity.isOnCooldown()) {
             hopperblockentity.setCooldown(0);
-            tryMoveItems(level, blockpos, blockstate, hopperblockentity, () -> {
+            // Spigot start
+            boolean result = tryMoveItems(level, blockpos, blockstate, hopperblockentity, () -> {
                 return suckInItems(level, hopperblockentity);
             });
+            if (!result && hopperblockentity.level.spigotConfig.hopperCheck > 1) {
+                hopperblockentity.setCooldown(hopperblockentity.level.spigotConfig.hopperCheck);
+            }
+            // Spigot end
         }
 
     }
@@ -170,7 +175,7 @@ public class HopperBlockEntity extends RandomizableContainerBlockEntity implemen
                 }
 
                 if (flag) {
-                    hopperblockentity.setCooldown(8);
+                    hopperblockentity.setCooldown(level.spigotConfig.hopperTransfer); // Spigot
                     setChanged(level, blockpos, blockstate);
                     return true;
                 }
@@ -208,7 +213,7 @@ public class HopperBlockEntity extends RandomizableContainerBlockEntity implemen
                         int j = itemstack.getCount();
                         // CraftBukkit start - Call event when pushing items into other inventories
                         ItemStack original = itemstack.copy();
-                        CraftItemStack oitemstack = CraftItemStack.asCraftMirror(hopperblockentity.removeItem(i, 1));
+                        CraftItemStack oitemstack = CraftItemStack.asCraftMirror(hopperblockentity.removeItem(i, level.spigotConfig.hopperAmount)); // Spigot
 
                         org.bukkit.inventory.Inventory destinationInventory;
                         // Have to special case large chests as they work oddly
@@ -224,9 +229,10 @@ public class HopperBlockEntity extends RandomizableContainerBlockEntity implemen
                         level.getCraftServer().getPluginManager().callEvent(event);
                         if (event.isCancelled()) {
                             hopperblockentity.setItem(i, original);
-                            hopperblockentity.setCooldown(8); // Delay hopper checks
+                            hopperblockentity.setCooldown(level.spigotConfig.hopperTransfer); // Delay hopper checks // Spigot
                             return false;
                         }
+                        int origCount = event.getItem().getAmount(); // Spigot
                         ItemStack itemstack1 = addItem(hopperblockentity, container, CraftItemStack.asNMSCopy(event.getItem()), direction);
                         // CraftBukkit end
 
@@ -236,7 +242,10 @@ public class HopperBlockEntity extends RandomizableContainerBlockEntity implemen
                         }
 
                         itemstack.setCount(j);
-                        if (j == 1) {
+                        // Spigot start
+                        itemstack.shrink(origCount - itemstack1.getCount());
+                        if (j <= level.spigotConfig.hopperAmount) {
+                            // Spigot end
                             hopperblockentity.setItem(i, itemstack);
                         }
                     }
@@ -303,7 +312,7 @@ public class HopperBlockEntity extends RandomizableContainerBlockEntity implemen
             Direction direction = Direction.DOWN;
 
             for (int i : getSlots(container, direction)) {
-                if (tryTakeInItemFromSlot(hopper, container, i, direction)) {
+                if (tryTakeInItemFromSlot(hopper, container, i, direction, level)) { // Spigot
                     return true;
                 }
             }
@@ -324,14 +333,14 @@ public class HopperBlockEntity extends RandomizableContainerBlockEntity implemen
         }
     }
 
-    private static boolean tryTakeInItemFromSlot(Hopper hopper, Container container, int i, Direction direction) {
+    private static boolean tryTakeInItemFromSlot(Hopper hopper, Container container, int i, Direction direction, Level level) { // Spigot
         ItemStack itemstack = container.getItem(i);
 
         if (!itemstack.isEmpty() && canTakeItemFromContainer(hopper, container, itemstack, i, direction)) {
             int j = itemstack.getCount();
             // CraftBukkit start - Call event on collection of items from inventories into the hopper
             ItemStack original = itemstack.copy();
-            CraftItemStack oitemstack = CraftItemStack.asCraftMirror(container.removeItem(i, 1));
+            CraftItemStack oitemstack = CraftItemStack.asCraftMirror(container.removeItem(i, level.spigotConfig.hopperAmount)); // Spigot
 
             org.bukkit.inventory.Inventory sourceInventory;
             // Have to special case large chests as they work oddly
@@ -350,11 +359,12 @@ public class HopperBlockEntity extends RandomizableContainerBlockEntity implemen
                 container.setItem(i, original);
 
                 if (hopper instanceof HopperBlockEntity) {
-                    ((HopperBlockEntity) hopper).setCooldown(8); // Delay hopper checks
+                    ((HopperBlockEntity) hopper).setCooldown(level.spigotConfig.hopperTransfer); // Spigot
                 }
 
                 return false;
             }
+            int origCount = event.getItem().getAmount(); // Spigot
             ItemStack itemstack1 = addItem(container, hopper, CraftItemStack.asNMSCopy(event.getItem()), null);
             // CraftBukkit end
 
@@ -364,7 +374,10 @@ public class HopperBlockEntity extends RandomizableContainerBlockEntity implemen
             }
 
             itemstack.setCount(j);
-            if (j == 1) {
+            // Spigot start
+            itemstack.shrink(origCount - itemstack1.getCount());
+            if (j <= level.spigotConfig.hopperAmount) {
+                // Spigot end
                 container.setItem(i, itemstack);
             }
         }
@@ -465,6 +478,11 @@ public class HopperBlockEntity extends RandomizableContainerBlockEntity implemen
             boolean flag1 = container1.isEmpty();
 
             if (itemstack1.isEmpty()) {
+                // Spigot start - SPIGOT-6693, InventorySubcontainer#setItem
+                if (!itemstack.isEmpty() && itemstack.getCount() > container1.getMaxStackSize()) {
+                    itemstack = itemstack.split(container1.getMaxStackSize());
+                }
+                // Spigot end
                 container1.setItem(i, itemstack);
                 itemstack = ItemStack.EMPTY;
                 flag = true;
@@ -492,7 +510,7 @@ public class HopperBlockEntity extends RandomizableContainerBlockEntity implemen
                             }
                         }
 
-                        hopperblockentity.setCooldown(8 - l);
+                        hopperblockentity.setCooldown(hopperblockentity.level.spigotConfig.hopperTransfer - l); // Spigot
                     }
                 }
 
@@ -555,6 +573,7 @@ public class HopperBlockEntity extends RandomizableContainerBlockEntity implemen
     }
 
     private static @Nullable Container getBlockContainer(Level level, BlockPos blockpos, BlockState blockstate) {
+        if ( !level.spigotConfig.hopperCanLoadChunks && !level.hasChunkAt( blockpos ) ) return null; // Spigot
         Block block = blockstate.getBlock();
 
         if (block instanceof WorldlyContainerHolder) {
diff --git a/src/main/java/org/spigotmc/SpigotWorldConfig.java b/src/main/java/org/spigotmc/SpigotWorldConfig.java
index ab984b2109..cec948a055 100644
--- a/src/main/java/org/spigotmc/SpigotWorldConfig.java
+++ b/src/main/java/org/spigotmc/SpigotWorldConfig.java
@@ -228,4 +228,22 @@ public class SpigotWorldConfig
         otherTrackingRange = getInt( "entity-tracking-range.other", otherTrackingRange );
         log( "Entity Tracking Range: Pl " + playerTrackingRange + " / An " + animalTrackingRange + " / Mo " + monsterTrackingRange + " / Mi " + miscTrackingRange + " / Di " + displayTrackingRange + " / Other " + otherTrackingRange );
     }
+
+    public int hopperTransfer;
+    public int hopperCheck;
+    public int hopperAmount;
+    public boolean hopperCanLoadChunks;
+    private void hoppers()
+    {
+        // Set the tick delay between hopper item movements
+        hopperTransfer = getInt( "ticks-per.hopper-transfer", 8 );
+        if ( SpigotConfig.version < 11 )
+        {
+            set( "ticks-per.hopper-check", 1 );
+        }
+        hopperCheck = getInt( "ticks-per.hopper-check", 1 );
+        hopperAmount = getInt( "hopper-amount", 1 );
+        hopperCanLoadChunks = getBoolean( "hopper-can-load-chunks", false );
+        log( "Hopper Transfer: " + hopperTransfer + " Hopper Check: " + hopperCheck + " Hopper Amount: " + hopperAmount + " Hopper Can Load Chunks: " + hopperCanLoadChunks );
+    }
 }
-- 
2.52.0

